<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Visor de Tesorería - Transacciones</title>
    <!-- Tailwind CSS para estilos rápidos y modernos -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts: Roboto para un look corporativo -->
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <style>
        /* Configuración de Colores Institucionales */
        :root {
            --color-primary: #003366; /* Azul Oscuro Corporativo */
            --color-secondary: #0055a5; /* Azul Medio */
            --color-accent: #fca311; /* Acento (Opcional, dorado/naranja) */
            --bg-light: #f4f6f8;
        }

        body {
            font-family: 'Roboto', sans-serif;
            background-color: var(--bg-light);
        }

        /* Estilos específicos para la tabla institucional */
        .table-header {
            background-color: var(--color-primary);
            color: white;
        }
        
        .btn-primary {
            background-color: var(--color-primary);
            transition: background-color 0.3s;
        }
        
        .btn-primary:hover {
            background-color: var(--color-secondary);
        }

        /* Animación de carga */
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--color-primary);
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            display: none; /* Oculto por defecto */
            margin: 0 auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="text-gray-800">

    <!-- Encabezado Institucional -->
    <header class="bg-white shadow-md">
        <div class="container mx-auto px-6 py-4 flex justify-between items-center">
            <div class="flex items-center gap-3">
                <!-- Icono representativo -->
                <div class="bg-blue-900 text-white p-2 rounded-lg">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                </div>
                <div>
                    <h1 class="text-2xl font-bold text-gray-800 tracking-tight">Tesorería</h1>
                    <p class="text-xs text-gray-500 uppercase tracking-wider">Visor de Transacciones</p>
                </div>
            </div>
            <div class="text-right hidden md:block">
                <p class="text-sm font-semibold text-gray-600">Usuario: Reportes</p>
                <p class="text-xs text-gray-400" id="current-date">Fecha</p>
            </div>
        </div>
    </header>

    <!-- Panel de Control y Filtros -->
    <main class="container mx-auto px-6 py-8">
        <div class="bg-white rounded-lg shadow-sm p-6 mb-6 border border-gray-200">
            <h2 class="text-lg font-semibold mb-4 text-gray-700 flex items-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z" />
                </svg>
                Filtros de Búsqueda
            </h2>
            
            <form id="searchForm" class="grid grid-cols-1 md:grid-cols-4 gap-4 items-end">
                <!-- Fecha Inicio -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Fecha Inicio</label>
                    <input type="date" id="rangeStart" required
                        class="w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-200 focus:ring-opacity-50 p-2 border">
                </div>

                <!-- Fecha Fin -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Fecha Fin</label>
                    <input type="date" id="rangeEnd" required
                        class="w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-200 focus:ring-opacity-50 p-2 border">
                </div>

                <!-- Botón Consultar -->
                <div>
                    <button type="submit" 
                        class="w-full btn-primary text-white font-bold py-2 px-4 rounded-md shadow hover:shadow-lg flex justify-center items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                        </svg>
                        Consultar
                    </button>
                </div>
            </form>
        </div>

        <!-- Mensajes de Estado -->
        <div id="statusMessage" class="hidden mb-4 p-4 rounded-md"></div>
        <div id="loader" class="loader mb-4"></div>

        <!-- Tabla de Resultados -->
        <div class="bg-white rounded-lg shadow overflow-hidden border border-gray-200">
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="table-header">
                        <tr>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">Fecha</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">Beneficiario / Tercero</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">ID Tercero</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">Banco</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">No. Cuenta</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">Detalle</th>
                            <th scope="col" class="px-6 py-3 text-right text-xs font-medium uppercase tracking-wider">Valor Pagado</th>
                        </tr>
                    </thead>
                    <tbody id="resultsBody" class="bg-white divide-y divide-gray-200 text-sm">
                        <!-- Aquí se insertarán los datos dinámicamente -->
                        <tr>
                            <td colspan="7" class="px-6 py-10 text-center text-gray-500">
                                Selecciona un rango de fechas y haz clic en "Consultar" para ver los resultados.
                            </td>
                        </tr>
                    </tbody>
                    <tfoot class="bg-gray-50">
                        <tr>
                            <td colspan="6" class="px-6 py-3 text-right font-bold text-gray-700">Total en Pantalla:</td>
                            <td class="px-6 py-3 text-right font-bold text-blue-900" id="totalAmount">$0.00</td>
                        </tr>
                    </tfoot>
                </table>
            </div>
        </div>
    </main>

    <footer class="bg-gray-800 text-white mt-12 py-6">
        <div class="container mx-auto px-6 text-center text-sm text-gray-400">
            <p>&copy; 2024 Departamento de Tesorería. Uso Interno Confidencial.</p>
        </div>
    </footer>

    <!-- Lógica JavaScript -->
    <script>
        // Configuración Inicial
        document.getElementById('current-date').textContent = new Date().toLocaleDateString('es-ES', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });

        // Función para formatear moneda (Pesos)
        const currencyFormatter = new Intl.NumberFormat('es-CO', {
            style: 'currency',
            currency: 'COP',
            minimumFractionDigits: 0
        });

        // Función para formatear fechas
        const dateFormatter = (dateString) => {
            if (!dateString) return '';
            const date = new Date(dateString);
            return date.toLocaleDateString('es-ES');
        };

        // Manejador del Formulario
        document.getElementById('searchForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const start = document.getElementById('rangeStart').value;
            const end = document.getElementById('rangeEnd').value;
            const tbody = document.getElementById('resultsBody');
            const loader = document.getElementById('loader');
            const statusMsg = document.getElementById('statusMessage');
            const totalEl = document.getElementById('totalAmount');

            // Limpiar UI
            tbody.innerHTML = '';
            statusMsg.classList.add('hidden');
            statusMsg.className = 'hidden mb-4 p-4 rounded-md'; // Reset clases
            loader.style.display = 'block';

            try {
                // LLAMADA A TU BACKEND (NODE.JS)
                const response = await fetch(`http://localhost:3000/api/voucher-transactions?rangeStart=${start}&rangeEnd=${end}`);
                
                if (!response.ok) throw new Error('Error al conectar con el servidor.');

                const result = await response.json();
                const data = result.data; // Tu API devuelve { success: true, data: [...] }

                loader.style.display = 'none';

                if (data.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="7" class="px-6 py-4 text-center text-gray-500">No se encontraron registros en este rango de fechas.</td></tr>';
                    totalEl.textContent = currencyFormatter.format(0);
                    return;
                }

                let totalSum = 0;

                // Renderizar filas
                data.forEach(row => {
                    // Nota: Usamos las claves exactas que definimos en el server.js
                    const tr = document.createElement('tr');
                    tr.className = 'hover:bg-blue-50 transition-colors';
                    
                    const valor = row['Valor Pagado'] || 0;
                    totalSum += valor;

                    tr.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap text-gray-600">${dateFormatter(row['Fecha del Comprobante'])}</td>
                        <td class="px-6 py-4 font-medium text-gray-900">${row['Tercero Nombre'] || 'N/A'}</td>
                        <td class="px-6 py-4 text-gray-500">${row['ID Tercero'] || ''}</td>
                        <td class="px-6 py-4 text-gray-500">${row['Entidad Bancaria'] || ''}</td>
                        <td class="px-6 py-4 text-gray-500 font-mono text-xs">${row['No. Cuenta Banco'] || ''}</td>
                        <td class="px-6 py-4 text-gray-500 text-xs max-w-xs truncate" title="${row['Detalle del Pago']}">${row['Detalle del Pago'] || ''}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-right font-bold text-gray-700">${currencyFormatter.format(valor)}</td>
                    `;
                    tbody.appendChild(tr);
                });

                // Actualizar Total
                totalEl.textContent = currencyFormatter.format(totalSum);

                // Mensaje de éxito
                statusMsg.textContent = `Se encontraron ${data.length} registros.`;
                statusMsg.classList.remove('hidden');
                statusMsg.classList.add('bg-green-100', 'text-green-700', 'border', 'border-green-200');

            } catch (error) {
                loader.style.display = 'none';
                console.error(error);
                statusMsg.innerHTML = `<strong>Error:</strong> No se pudo obtener la información. Asegúrate de que el servidor (server.js) esté ejecutándose en la terminal.`;
                statusMsg.classList.remove('hidden');
                statusMsg.classList.add('bg-red-100', 'text-red-700', 'border', 'border-red-200');
            }
        });
    </script>
</body>
</html>